<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Birlikte Çalışıyoruz</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f4f4f9;
      margin-top: 30px;
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      display: inline-block;
      padding: 30px 40px;
      width: 370px;
      margin-bottom: 30px;
    }
    canvas {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
      transition: background-color 0.3s;
    }
    .start { background: #4CAF50; }
    .start:hover { background: #45a049; }
    .break { background: #E53935; }
    .break:hover { background: #d32f2f; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Birlikte Çalışıyoruz 💞</h2>
    <img src="bizim-resim.jpg" alt="Yusuf ve Sebiha fotoğrafı" style="width:150px;height:150px;border-radius:50%;border:4px solid #f0f0f0;object-fit:cover;margin-bottom:10px;">

    <h4 id="jointTimer">Bugün birlikte çalışılan süre: Hesaplanıyor...</h4>
    <h4 id="yusufTimer">Yusuf'un bugünkü çalışma süresi: Hesaplanıyor...</h4>
    <h4 id="sebihaTimer">Sebiha'nın bugünkü çalışma süresi: Hesaplanıyor...</h4>

    <p id="yusufStatus">Yusuf: —</p>
    <p id="sebihaStatus">Sebiha: —</p>

    <h3>Ben kimim?</h3>
    <button onclick="setUser('yusuf')">Yusuf</button>
    <button onclick="setUser('sebiha')">Sebiha</button>

    <div id="controls" style="display:none;">
      <h3 id="userName"></h3>
      <button class="start" onclick="setStatus('working')">Çalışmaya Başla</button>
      <button class="break" onclick="setStatus('break')">Mola Ver</button>
    </div>
  </div>

  <!-- Grafikler -->
  <div>
    <h2>📊 Haftalık Çalışma Grafiği</h2>
    <canvas id="weeklyChart" width="400" height="200"></canvas>

    <h2>📅 Aylık Çalışma Grafiği</h2>
    <canvas id="monthlyChart" width="400" height="200"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWWH-5ca4YrF2hr8LsYC_fa-7ayqnnH8A",
      authDomain: "sevgilimle-koza.firebaseapp.com",
      databaseURL: "https://sevgilimle-koza-default-rtdb.firebaseio.com",
      projectId: "sevgilimle-koza",
      storageBucket: "sevgilimle-koza.firebasestorage.app",
      messagingSenderId: "680126325287",
      appId: "1:680126325287:web:427c51830bbb1a26026402",
      measurementId: "G-GHF9ZM3PPV"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let timerInterval = null;

    function getTodayDateString() {
      const t = new Date();
      return t.toISOString().slice(0,10);
    }

    function setUser(name) {
      currentUser = name;
      document.getElementById('controls').style.display = 'block';
      document.getElementById('userName').textContent = name === 'yusuf' ? 'Yusuf olarak girdin' : 'Sebiha olarak girdin';
    }

    function setStatus(status) {
      if (!currentUser) return alert("Önce kim olduğunu seç!");
      db.ref('users/' + currentUser).set({
        status,
        time: new Date().toLocaleTimeString('tr-TR')
      });
    }

    db.ref().on('value', (snap) => {
      const data = snap.val() || {};
      const users = data.users || {};
      let session = data.session || {};
      const today = getTodayDateString();

      if (session.date && session.date !== today) {
        // 🔁 Gün değişti → veriyi /history içine yaz
        db.ref('history/' + session.date).set({
          yusufTotal: session.yusufTotal || 0,
          sebihaTotal: session.sebihaTotal || 0,
          jointTotal: session.dailyTotalWorkTimeInSeconds || 0
        });
        // Günlük sıfırlama
        db.ref('session').set({
          date: today,
          dailyTotalWorkTimeInSeconds: 0,
          jointWorkStartTime: null,
          yusufTotal: 0,
          sebihaTotal: 0,
          yusufStart: null,
          sebihaStart: null
        });
        return;
      }

      const isYusufWorking = users.yusuf?.status === 'working';
      const isSebihaWorking = users.sebiha?.status === 'working';
      const areBothWorking = isYusufWorking && isSebihaWorking;

      document.getElementById('yusufStatus').textContent = "Yusuf: " + (isYusufWorking ? "Çalışıyor ⏳" : "Mola ☕");
      document.getElementById('sebihaStatus').textContent = "Sebiha: " + (isSebihaWorking ? "Çalışıyor ⏳" : "Mola ☕");

      const now = Date.now();

      let {
        jointWorkStartTime,
        dailyTotalWorkTimeInSeconds = 0,
        yusufStart,
        sebihaStart,
        yusufTotal = 0,
        sebihaTotal = 0
      } = session;

      // Kişisel çalışma güncellemeleri
      if (isYusufWorking && !yusufStart) db.ref('session/yusufStart').set(firebase.database.ServerValue.TIMESTAMP);
      if (!isYusufWorking && yusufStart) {
        const elapsed = (now - yusufStart) / 1000;
        db.ref('session').update({ yusufStart: null, yusufTotal: yusufTotal + elapsed });
      }

      if (isSebihaWorking && !sebihaStart) db.ref('session/sebihaStart').set(firebase.database.ServerValue.TIMESTAMP);
      if (!isSebihaWorking && sebihaStart) {
        const elapsed = (now - sebihaStart) / 1000;
        db.ref('session').update({ sebihaStart: null, sebihaTotal: sebihaTotal + elapsed });
      }

      // Ortak çalışma güncellemeleri
      if (areBothWorking && !jointWorkStartTime)
        db.ref('session/jointWorkStartTime').set(firebase.database.ServerValue.TIMESTAMP);
      if (!areBothWorking && jointWorkStartTime) {
        const elapsed = (now - jointWorkStartTime) / 1000;
        db.ref('session').update({
          jointWorkStartTime: null,
          dailyTotalWorkTimeInSeconds: dailyTotalWorkTimeInSeconds + elapsed
        });
      }

      updateTimers({ areBothWorking, jointWorkStartTime, dailyTotalWorkTimeInSeconds, yusufStart, sebihaStart, yusufTotal, sebihaTotal });
    });

    function updateTimers({ areBothWorking, jointWorkStartTime, dailyTotalWorkTimeInSeconds, yusufStart, sebihaStart, yusufTotal, sebihaTotal }) {
      if (timerInterval) clearInterval(timerInterval);

      const formatTime = (sec) => {
        sec = Math.floor(sec);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return `${h ? h+'s ' : ''}${m ? m+'d ' : ''}${s}s`;
      };

      timerInterval = setInterval(() => {
        const now = Date.now();
        let joint = dailyTotalWorkTimeInSeconds;
        let yusuf = yusufTotal;
        let sebiha = sebihaTotal;

        if (areBothWorking && jointWorkStartTime) joint += (now - jointWorkStartTime) / 1000;
        if (yusufStart) yusuf += (now - yusufStart) / 1000;
        if (sebihaStart) sebiha += (now - sebihaStart) / 1000;

        document.getElementById('jointTimer').textContent = "Bugün birlikte çalışılan süre: " + formatTime(joint);
        document.getElementById('yusufTimer').textContent = "Yusuf'un bugünkü çalışma süresi: " + formatTime(yusuf);
        document.getElementById('sebihaTimer').textContent = "Sebiha'nın bugünkü çalışma süresi: " + formatTime(sebiha);
      }, 1000);
    }

    // 🔢 Grafik fonksiyonu
    function renderCharts(history) {
      const dates = Object.keys(history).sort();
      const yusufData = dates.map(d => history[d].yusufTotal / 3600);
      const sebihaData = dates.map(d => history[d].sebihaTotal / 3600);
      const jointData = dates.map(d => history[d].jointTotal / 3600);

      // Haftalık
      const last7 = dates.slice(-7);
      const weekly = new Chart(document.getElementById('weeklyChart'), {
        type: 'bar',
        data: {
          labels: last7,
          datasets: [
            { label: 'Yusuf', data: last7.map(d => history[d].yusufTotal / 3600), backgroundColor: '#4CAF50' },
            { label: 'Sebiha', data: last7.map(d => history[d].sebihaTotal / 3600), backgroundColor: '#E91E63' },
            { label: 'Birlikte', data: last7.map(d => history[d].jointTotal / 3600), backgroundColor: '#3F51B5' },
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Saat' } } } }
      });

      // Aylık
      const last30 = dates.slice(-30);
      const monthly = new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
          labels: last30,
          datasets: [
            { label: 'Yusuf', data: last30.map(d => history[d].yusufTotal / 3600), backgroundColor: '#4CAF50' },
            { label: 'Sebiha', data: last30.map(d => history[d].sebihaTotal / 3600), backgroundColor: '#E91E63' },
            { label: 'Birlikte', data: last30.map(d => history[d].jointTotal / 3600), backgroundColor: '#3F51B5' },
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Saat' } } } }
      });
    }

    // 🔄 Grafikleri yükle
    db.ref('history').on('value', (snap) => {
      const history = snap.val() || {};
      if (Object.keys(history).length > 0) renderCharts(history);
    });
  </script>
  
  
<!-- 🔹 GÜNLÜK ÇALIŞMA KAYIT SİSTEMİ EKLENTİSİ -->
<script>
  // Günlük çalışma süresini history altına kaydeden fonksiyon
  function saveDailyWorkToHistory(yusufSeconds, sebihaSeconds, togetherSeconds) {
    const todayString = getTodayDateString();
    const ref = db.ref("history/" + todayString);

    ref.set({
      yusuf: yusufSeconds,
      sebiha: sebihaSeconds,
      together: togetherSeconds
    });
  }

  // --- Gün sonu veya oturum bittiğinde çağrılacak ---
  // Örnek: Ortak çalışma bittiğinde her iki kişinin toplam süresini kaydet
  function endOfDaySave() {
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      const yusuf = users.yusuf?.totalSeconds || 0;
      const sebiha = users.sebiha?.totalSeconds || 0;

      db.ref("session").once("value").then(sessionSnap => {
        const session = sessionSnap.val() || {};
        const together = session.dailyTotalWorkTimeInSeconds || 0;

        saveDailyWorkToHistory(yusuf, sebiha, together);
        console.log("✅ Günlük çalışma geçmişe kaydedildi:", getTodayDateString());
      });
    });
  }

  // --- Her gece 23:59'da otomatik kayıt ---
  function scheduleDailySave() {
    const now = new Date();
    const millisTillMidnight =
      new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 5, 0) - now;
    setTimeout(() => {
      endOfDaySave();
      scheduleDailySave(); // sonraki gün için tekrar kur
    }, millisTillMidnight);
  }

  scheduleDailySave();
</script>

</body>
</html>



